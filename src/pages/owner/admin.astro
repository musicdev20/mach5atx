---
import '../../styles/globals.css';

export const prerender = false;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex,nofollow" />
        <title>Mach 5 Unified Admin</title>
    </head>
    <body class="m5-admin-body">
        <div class="m5-checker" aria-hidden="true"></div>
        <main class="m5-admin-wrap">
            <section class="m5-admin-panel">
                <header class="m5-admin-header">
                    <img src="/images/logos/m5logo2.webp" alt="Mach 5" />
                    <h1>Unified Admin</h1>
                    <p>Manage artists, venues, and shows in one place.</p>
                </header>

                <section id="loginPanel" class="m5-admin-login">
                    <label>
                        Admin Password
                        <input id="adminPassword" type="password" autocomplete="current-password" />
                    </label>
                    <button id="loginButton" type="button">Unlock</button>
                    <p id="loginMessage" class="m5-admin-msg"></p>
                </section>

                <section id="editorPanel" class="m5-admin-editor" hidden>
                    <div class="m5-admin-actions">
                        <button id="addArtistButton" type="button">Add Artist</button>
                        <button id="addVenueButton" type="button">Add Venue</button>
                        <button id="addShowButton" type="button">Add Show</button>
                        <button id="saveAllButton" type="button">Save All</button>
                        <button id="logoutButton" type="button">Lock</button>
                    </div>
                    <p id="editorMessage" class="m5-admin-msg"></p>

                    <section class="m5-admin-group">
                        <h2>Venues</h2>
                        <p class="m5-admin-hint">Shows select from this venue list.</p>
                        <div id="venuesList" class="m5-admin-list"></div>
                    </section>

                    <section class="m5-admin-group">
                        <h2>Shows</h2>
                        <p class="m5-admin-hint">Choose a venue for each show. Venue details are linked automatically.</p>
                        <div id="showsList" class="m5-admin-list"></div>
                    </section>

                    <section class="m5-admin-group">
                        <h2>Artists & Songs</h2>
                        <div id="artistsList" class="m5-admin-list"></div>
                    </section>
                </section>
            </section>
        </main>

        <template id="artistRowTemplate">
            <article class="m5-row m5-artist-row">
                <label>Artist Name<input data-field="name" type="text" /></label>
                <label>Artist ID<input data-field="id" type="text" placeholder="journey" /></label>
                <label class="m5-span-2">Songs (one per line)<textarea data-field="songs" rows="5"></textarea></label>
                <label class="m5-span-2">Tile Image URL (optional)<input data-field="imageUrl" type="text" placeholder="/images/live/bandlive1.jpg" /></label>
                <button data-action="remove" type="button">Remove</button>
            </article>
        </template>

        <template id="venueRowTemplate">
            <article class="m5-row m5-venue-row">
                <label>Venue Name<input data-field="name" type="text" /></label>
                <label>Venue ID<input data-field="id" type="text" placeholder="shooters-round-rock" /></label>
                <label>Address<input data-field="address" type="text" placeholder="1208 N I-35 Frontage Rd, Round Rock, TX" /></label>
                <label>Directions URL<input data-field="directionsUrl" type="url" placeholder="https://maps.google.com/?q=..." /></label>
                <label>Logo URL (optional)<input data-field="logoUrl" type="text" placeholder="/images/logos/m5logo2.webp" /></label>
                <button data-action="remove" type="button">Remove</button>
            </article>
        </template>

        <template id="showRowTemplate">
            <article class="m5-row m5-show-row">
                <label>Event Name<input data-field="eventName" type="text" /></label>
                <label>Start Date/Time (ISO)<input data-field="startDateTime" type="text" placeholder="2026-03-21T20:00:00-05:00" /></label>
                <label>Venue
                    <select data-field="venueId"></select>
                </label>
                <label>Show ID<input data-field="id" type="text" /></label>
                <p class="m5-linked-preview" data-field="venuePreview"></p>
                <button data-action="remove" type="button">Remove</button>
            </article>
        </template>
    </body>
</html>

<style>
    .m5-admin-body {
        margin: 0;
        color: #f5f7fb;
        font-family: 'Inter Variable', ui-sans-serif, system-ui, sans-serif;
        background: radial-gradient(120% 120% at 50% 0%, #0d1222 0%, #02050f 58%, #01030a 100%);
    }
    .m5-checker {
        height: 48px;
        background:
            linear-gradient(180deg, rgb(255 255 255 / 10%) 0%, rgb(255 255 255 / 0%) 35%),
            url('/images/checkerboard.svg') center / auto 100% repeat-x;
        border-bottom: 1px solid #343a4a;
        box-shadow: inset 0 -1px 0 rgb(255 255 255 / 20%), 0 8px 24px rgb(0 0 0 / 30%);
    }
    .m5-admin-wrap {
        width: min(1200px, 100% - 2rem);
        margin: 1.25rem auto 2rem;
    }
    .m5-admin-panel {
        border: 1px solid rgb(255 255 255 / 18%);
        border-radius: 1rem;
        padding: 1rem;
        background: linear-gradient(180deg, rgb(11 14 30 / 96%) 0%, rgb(9 12 23 / 94%) 100%);
    }
    .m5-admin-header {
        text-align: center;
        margin-bottom: 0.85rem;
    }
    .m5-admin-header img {
        width: min(280px, 70vw);
    }
    .m5-admin-header h1 {
        margin: 0.4rem 0 0.2rem;
        font-size: 1.8rem;
    }
    .m5-admin-header p {
        margin: 0;
        color: rgb(230 233 242 / 82%);
    }
    .m5-admin-login {
        display: flex;
        gap: 0.6rem;
        align-items: end;
        flex-wrap: wrap;
    }
    .m5-admin-login label {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: min(420px, 100%);
    }
    .m5-admin-login input,
    .m5-row input,
    .m5-row textarea,
    .m5-row select {
        border: 1px solid rgb(255 255 255 / 24%);
        border-radius: 0.5rem;
        background: rgb(8 12 23 / 75%);
        color: #f5f7fb;
        padding: 0.5rem 0.6rem;
        font: inherit;
    }
    .m5-admin-login button,
    .m5-admin-actions button,
    .m5-row button {
        border: 1px solid rgb(255 255 255 / 26%);
        border-radius: 0.55rem;
        background: rgb(12 17 31 / 85%);
        color: #fff;
        font: inherit;
        font-weight: 700;
        padding: 0.55rem 0.8rem;
        cursor: pointer;
    }
    .m5-admin-actions button:hover,
    .m5-admin-login button:hover,
    .m5-row button:hover {
        border-color: #ff4e56;
        color: #ff4e56;
    }
    .m5-admin-editor {
        display: grid;
        gap: 0.9rem;
    }
    .m5-admin-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.55rem;
    }
    .m5-admin-group {
        border: 1px solid rgb(255 255 255 / 14%);
        border-radius: 0.8rem;
        padding: 0.8rem;
        background: rgb(7 11 21 / 45%);
    }
    .m5-admin-group h2 {
        margin: 0;
        font-size: 1.15rem;
    }
    .m5-admin-hint {
        margin: 0.2rem 0 0.5rem;
        color: rgb(230 233 242 / 78%);
        font-size: 0.92rem;
    }
    .m5-admin-list {
        display: grid;
        gap: 0.75rem;
    }
    .m5-row {
        border: 1px solid rgb(255 255 255 / 16%);
        border-radius: 0.8rem;
        padding: 0.7rem;
        display: grid;
        gap: 0.6rem 0.7rem;
        align-items: end;
    }
    .m5-artist-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .m5-venue-row,
    .m5-show-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .m5-row label {
        display: flex;
        flex-direction: column;
        gap: 0.23rem;
        font-size: 0.92rem;
    }
    .m5-span-2 {
        grid-column: span 2;
    }
    .m5-linked-preview {
        margin: 0;
        padding: 0.45rem 0.55rem;
        border-radius: 0.5rem;
        border: 1px solid rgb(255 255 255 / 14%);
        color: rgb(226 231 244 / 84%);
        background: rgb(10 14 24 / 65%);
        font-size: 0.9rem;
        line-height: 1.35;
    }
    .m5-admin-msg {
        margin: 0;
        color: rgb(230 233 242 / 86%);
        min-height: 1.25em;
    }
    @media (max-width: 860px) {
        .m5-checker {
            height: 32px;
            background-size: auto 100%, auto 100%;
        }
        .m5-admin-wrap {
            width: min(1200px, 100% - 1rem);
            margin-top: 0.7rem;
        }
        .m5-artist-row,
        .m5-venue-row,
        .m5-show-row {
            grid-template-columns: 1fr;
        }
        .m5-span-2 {
            grid-column: auto;
        }
    }
</style>

<script is:inline>
    (() => {
        const loginPanel = document.getElementById('loginPanel');
        const editorPanel = document.getElementById('editorPanel');
        const loginButton = document.getElementById('loginButton');
        const addArtistButton = document.getElementById('addArtistButton');
        const addVenueButton = document.getElementById('addVenueButton');
        const addShowButton = document.getElementById('addShowButton');
        const saveAllButton = document.getElementById('saveAllButton');
        const logoutButton = document.getElementById('logoutButton');
        const adminPassword = document.getElementById('adminPassword');
        const loginMessage = document.getElementById('loginMessage');
        const editorMessage = document.getElementById('editorMessage');

        const artistsList = document.getElementById('artistsList');
        const venuesList = document.getElementById('venuesList');
        const showsList = document.getElementById('showsList');

        const artistTemplate = document.getElementById('artistRowTemplate');
        const venueTemplate = document.getElementById('venueRowTemplate');
        const showTemplate = document.getElementById('showRowTemplate');

        const setEditorVisible = (visible) => {
            loginPanel.hidden = visible;
            editorPanel.hidden = !visible;
        };

        const setMessage = (el, text) => {
            el.textContent = text;
        };

        const collectVenues = () =>
            Array.from(venuesList.querySelectorAll('.m5-venue-row')).map((row, index) => {
                const read = (field) => row.querySelector(`[data-field="${field}"]`)?.value.trim() ?? '';
                const name = read('name');
                const address = read('address');
                const id =
                    read('id') ||
                    `${name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '') || 'venue'}-${index + 1}`;
                const directions = read('directionsUrl') || `https://maps.google.com/?q=${encodeURIComponent(address)}`;
                return {
                    id,
                    name,
                    address,
                    directionsUrl: directions,
                    logoUrl: read('logoUrl') || '/images/logos/m5logo2.webp'
                };
            });

        const populateVenueSelect = (select, selectedId = '') => {
            const venues = collectVenues();
            select.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select a venue';
            select.appendChild(placeholder);

            venues.forEach((venue) => {
                const option = document.createElement('option');
                option.value = venue.id;
                option.textContent = `${venue.name} (${venue.address})`;
                select.appendChild(option);
            });

            select.value = selectedId && venues.some((venue) => venue.id === selectedId) ? selectedId : '';
        };

        const refreshVenueSelects = () => {
            showsList.querySelectorAll('[data-field="venueId"]').forEach((select) => {
                const current = select.value;
                populateVenueSelect(select, current);
                updateShowPreview(select.closest('.m5-show-row'));
            });
        };

        const updateShowPreview = (row) => {
            if (!row) return;
            const preview = row.querySelector('[data-field="venuePreview"]');
            const venueId = row.querySelector('[data-field="venueId"]')?.value;
            const venue = collectVenues().find((item) => item.id === venueId);
            preview.textContent = venue
                ? `Linked Venue: ${venue.name} â€” ${venue.address}`
                : 'Linked Venue: none selected';
        };

        const createVenueRow = (venue = {}) => {
            const node = venueTemplate.content.firstElementChild.cloneNode(true);
            node.querySelectorAll('[data-field]').forEach((input) => {
                const key = input.getAttribute('data-field');
                input.value = typeof venue[key] === 'string' ? venue[key] : '';
            });
            node.querySelector('[data-action="remove"]').addEventListener('click', () => {
                node.remove();
                refreshVenueSelects();
            });
            node.querySelectorAll('[data-field]').forEach((input) => {
                input.addEventListener('input', refreshVenueSelects);
            });
            venuesList.appendChild(node);
            refreshVenueSelects();
        };

        const createShowRow = (show = {}) => {
            const node = showTemplate.content.firstElementChild.cloneNode(true);
            const venueSelect = node.querySelector('[data-field="venueId"]');

            node.querySelectorAll('[data-field]').forEach((input) => {
                const key = input.getAttribute('data-field');
                if (key === 'venuePreview' || key === 'venueId') return;
                input.value = typeof show[key] === 'string' ? show[key] : '';
            });

            const fallbackVenueId =
                typeof show.venueId === 'string' && show.venueId.length > 0
                    ? show.venueId
                    : collectVenues().find((venue) => venue.name === show.venueName)?.id || '';
            populateVenueSelect(venueSelect, fallbackVenueId);
            venueSelect.addEventListener('change', () => updateShowPreview(node));
            updateShowPreview(node);

            node.querySelector('[data-action="remove"]').addEventListener('click', () => node.remove());
            showsList.appendChild(node);
        };

        const createArtistRow = (artist = {}) => {
            const node = artistTemplate.content.firstElementChild.cloneNode(true);
            node.querySelectorAll('[data-field]').forEach((input) => {
                const key = input.getAttribute('data-field');
                if (key === 'songs') {
                    input.value = Array.isArray(artist.songs) ? artist.songs.join('\n') : '';
                } else {
                    input.value = typeof artist[key] === 'string' ? artist[key] : '';
                }
            });
            node.querySelector('[data-action="remove"]').addEventListener('click', () => node.remove());
            artistsList.appendChild(node);
        };

        const collectShows = () => {
            const venues = collectVenues();
            return Array.from(showsList.querySelectorAll('.m5-show-row')).map((row, index) => {
                const read = (field) => row.querySelector(`[data-field="${field}"]`)?.value.trim() ?? '';
                const venueId = read('venueId');
                const venue = venues.find((item) => item.id === venueId);
                return {
                    id: read('id') || `show-${Date.now()}-${index}`,
                    eventName: read('eventName'),
                    startDateTime: read('startDateTime'),
                    venueId,
                    venueName: venue?.name ?? '',
                    venueAddress: venue?.address ?? '',
                    directionsUrl: venue?.directionsUrl ?? '',
                    venueLogo: venue?.logoUrl || '/images/logos/m5logo2.webp'
                };
            });
        };

        const collectArtists = () =>
            Array.from(artistsList.querySelectorAll('.m5-artist-row')).map((row, index) => {
                const read = (field) => row.querySelector(`[data-field="${field}"]`)?.value.trim() ?? '';
                const songs = read('songs')
                    .split('\n')
                    .map((song) => song.trim())
                    .filter(Boolean);
                return {
                    id: read('id') || `artist-${Date.now()}-${index}`,
                    name: read('name'),
                    songs,
                    imageUrl: read('imageUrl') || undefined
                };
            });

        const loadAll = async () => {
            const [artistsRes, venuesRes, showsRes] = await Promise.all([fetch('/api/artists'), fetch('/api/venues'), fetch('/api/shows')]);
            const [artistsData, venuesData, showsData] = await Promise.all([artistsRes.json(), venuesRes.json(), showsRes.json()]);

            artistsList.innerHTML = '';
            venuesList.innerHTML = '';
            showsList.innerHTML = '';

            (venuesData.venues ?? []).forEach((venue) => createVenueRow(venue));
            (showsData.shows ?? []).forEach((show) => createShowRow(show));
            (artistsData.artists ?? []).forEach((artist) => createArtistRow(artist));
        };

        const login = async () => {
            setMessage(loginMessage, '');
            const password = adminPassword.value;
            const response = await fetch('/api/shows-login', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                setMessage(loginMessage, error.error ?? 'Unable to log in.');
                return;
            }
            await loadAll();
            setEditorVisible(true);
        };

        const saveAll = async () => {
            setMessage(editorMessage, '');
            const venues = collectVenues();
            const shows = collectShows();
            const artists = collectArtists();

            const responses = await Promise.all([
                fetch('/api/venues', {
                    method: 'PUT',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ venues })
                }),
                fetch('/api/shows', {
                    method: 'PUT',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ shows })
                }),
                fetch('/api/artists', {
                    method: 'PUT',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ artists })
                })
            ]);

            const failed = responses.find((res) => !res.ok);
            if (failed) {
                const error = await failed.json().catch(() => ({}));
                setMessage(editorMessage, error.error ?? 'Save failed.');
                return;
            }

            setMessage(editorMessage, 'Saved. Artists, venues, and shows are updated.');
            refreshVenueSelects();
        };

        const logout = async () => {
            await fetch('/api/shows-logout', { method: 'POST' });
            adminPassword.value = '';
            setEditorVisible(false);
            setMessage(loginMessage, 'Locked.');
            setMessage(editorMessage, '');
            artistsList.innerHTML = '';
            venuesList.innerHTML = '';
            showsList.innerHTML = '';
        };

        loginButton.addEventListener('click', login);
        adminPassword.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                login();
            }
        });

        addArtistButton.addEventListener('click', () => createArtistRow());
        addVenueButton.addEventListener('click', () => createVenueRow());
        addShowButton.addEventListener('click', () => createShowRow());
        saveAllButton.addEventListener('click', saveAll);
        logoutButton.addEventListener('click', logout);
    })();
</script>
