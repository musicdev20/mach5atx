---
import '../../styles/globals.css';

export const prerender = false;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex,nofollow" />
        <title>Mach 5 Unified Admin</title>
    </head>
    <body class="m5-admin-body">
        <div class="m5-checker" aria-hidden="true"></div>
        <main class="m5-admin-wrap">
            <section class="m5-admin-panel">
                <header class="m5-admin-header">
                    <img src="/images/logos/m5logo2.webp" alt="Mach 5" />
                    <h1>Unified Admin</h1>
                    <p>Manage artists, venues, and shows in one place.</p>
                </header>

                <section id="loginPanel" class="m5-admin-login">
                    <label>
                        Admin Password
                        <input id="adminPassword" type="password" autocomplete="current-password" />
                    </label>
                    <button id="loginButton" type="button">Unlock</button>
                    <p id="loginMessage" class="m5-admin-msg"></p>
                </section>

                <section id="editorPanel" class="m5-admin-editor" hidden>
                    <div class="m5-admin-actions">
                        <button id="saveAllButton" type="button">Save All Changes</button>
                        <button id="logoutButton" type="button">Lock</button>
                    </div>
                    <p id="editorMessage" class="m5-admin-msg"></p>

                    <div class="m5-tab-bar" role="tablist" aria-label="Admin sections">
                        <button type="button" role="tab" id="tabArtists" class="m5-tab-btn is-active" aria-selected="true" data-tab="artists">Artists</button>
                        <button type="button" role="tab" id="tabVenues" class="m5-tab-btn" aria-selected="false" data-tab="venues">Venues</button>
                        <button type="button" role="tab" id="tabShows" class="m5-tab-btn" aria-selected="false" data-tab="shows">Shows</button>
                    </div>

                    <section id="panelArtists" class="m5-tab-panel" role="tabpanel" aria-labelledby="tabArtists" data-panel="artists">
                        <div class="m5-panel-head">
                            <h2>Artists & Songs</h2>
                            <button id="addArtistButton" type="button">Add Artist</button>
                        </div>
                        <div id="artistsList" class="m5-admin-list"></div>
                    </section>

                    <section id="panelVenues" class="m5-tab-panel" role="tabpanel" aria-labelledby="tabVenues" data-panel="venues" hidden>
                        <div class="m5-panel-head">
                            <h2>Venues</h2>
                            <button id="addVenueButton" type="button">Add Venue</button>
                        </div>
                        <p class="m5-admin-hint">Required fields: ID, name, address, and directions URL. Logo URL is optional.</p>
                        <div id="venuesList" class="m5-admin-list"></div>
                    </section>

                    <section id="panelShows" class="m5-tab-panel" role="tabpanel" aria-labelledby="tabShows" data-panel="shows" hidden>
                        <div class="m5-panel-head">
                            <h2>Shows</h2>
                            <button id="addShowButton" type="button">Add Show</button>
                        </div>
                        <p class="m5-admin-hint">Each show must select a venue from the venues tab. Venue details are linked automatically.</p>
                        <div id="showsList" class="m5-admin-list"></div>
                    </section>
                </section>
            </section>
        </main>

        <dialog id="artistModal" class="m5-modal">
            <form id="artistModalForm" class="m5-modal-form" method="dialog">
                <h3>Add Artist</h3>
                <label>Artist Name<input name="name" type="text" required /></label>
                <label>Artist ID<input name="id" type="text" placeholder="journey" /></label>
                <label>Songs (one per line)<textarea name="songs" rows="6"></textarea></label>
                <label>Tile Image URL (optional)<input name="imageUrl" type="text" placeholder="/images/live/bandlive1.jpg" /></label>
                <div class="m5-modal-actions">
                    <button type="button" data-action="cancel">Cancel</button>
                    <button type="submit" data-action="save">Save</button>
                </div>
            </form>
        </dialog>

        <dialog id="venueModal" class="m5-modal">
            <form id="venueModalForm" class="m5-modal-form" method="dialog">
                <h3>Add Venue</h3>
                <label>Venue Name<input name="name" type="text" required /></label>
                <label>Venue ID<input name="id" type="text" placeholder="shooters-round-rock" /></label>
                <label>Address<input name="address" type="text" placeholder="1208 N I-35 Frontage Rd, Round Rock, TX" required /></label>
                <label>Directions URL<input name="directionsUrl" type="url" placeholder="https://maps.google.com/?q=..." required /></label>
                <label>Logo URL (optional)<input name="logoUrl" type="text" placeholder="/images/logos/m5logo2.webp" /></label>
                <div class="m5-modal-actions">
                    <button type="button" data-action="cancel">Cancel</button>
                    <button type="submit" data-action="save">Save</button>
                </div>
            </form>
        </dialog>

        <dialog id="showModal" class="m5-modal">
            <form id="showModalForm" class="m5-modal-form" method="dialog">
                <h3>Add Show</h3>
                <label>Event Name<input name="eventName" type="text" required /></label>
                <label>Start Date/Time<input name="startDateTime" type="datetime-local" step="60" required /></label>
                <label>Venue
                    <select name="venueId" required>
                        <option value="">Select a venue</option>
                    </select>
                </label>
                <label>Show ID<input name="id" type="text" /></label>
                <div class="m5-modal-actions">
                    <button type="button" data-action="cancel">Cancel</button>
                    <button type="submit" data-action="save">Save</button>
                </div>
            </form>
        </dialog>

        <template id="artistRowTemplate">
            <article class="m5-row m5-artist-row">
                <label>Artist Name<input data-field="name" type="text" /></label>
                <label>Artist ID<input data-field="id" type="text" placeholder="journey" /></label>
                <label class="m5-span-2">Songs (one per line)<textarea data-field="songs" rows="5"></textarea></label>
                <label class="m5-span-2">Tile Image URL (optional)<input data-field="imageUrl" type="text" placeholder="/images/live/bandlive1.jpg" /></label>
                <button data-action="remove" type="button">Remove</button>
            </article>
        </template>

        <template id="venueRowTemplate">
            <article class="m5-row m5-venue-row">
                <label>Venue Name<input data-field="name" type="text" /></label>
                <label>Venue ID<input data-field="id" type="text" placeholder="shooters-round-rock" /></label>
                <label>Address<input data-field="address" type="text" placeholder="1208 N I-35 Frontage Rd, Round Rock, TX" /></label>
                <label>Directions URL<input data-field="directionsUrl" type="url" placeholder="https://maps.google.com/?q=..." /></label>
                <label>Logo URL (optional)<input data-field="logoUrl" type="text" placeholder="/images/logos/m5logo2.webp" /></label>
                <button data-action="remove" type="button">Remove</button>
            </article>
        </template>

        <template id="showRowTemplate">
            <article class="m5-row m5-show-row">
                <label>Event Name<input data-field="eventName" type="text" /></label>
                <label>Start Date/Time<input data-field="startDateTime" type="datetime-local" step="60" /></label>
                <label>Venue
                    <select data-field="venueId"></select>
                </label>
                <label>Show ID<input data-field="id" type="text" /></label>
                <p class="m5-linked-preview" data-field="venuePreview"></p>
                <button data-action="remove" type="button">Remove</button>
            </article>
        </template>
    </body>
</html>

<style>
    .m5-admin-body {
        margin: 0;
        color: #f5f7fb;
        font-family: 'Inter Variable', ui-sans-serif, system-ui, sans-serif;
        background: radial-gradient(120% 120% at 50% 0%, #0d1222 0%, #02050f 58%, #01030a 100%);
    }
    .m5-checker {
        height: 48px;
        background:
            linear-gradient(180deg, rgb(255 255 255 / 10%) 0%, rgb(255 255 255 / 0%) 35%),
            url('/images/checkerboard.svg') center / auto 100% repeat-x;
        border-bottom: 1px solid #343a4a;
        box-shadow: inset 0 -1px 0 rgb(255 255 255 / 20%), 0 8px 24px rgb(0 0 0 / 30%);
    }
    .m5-admin-wrap {
        width: min(1200px, 100% - 2rem);
        margin: 1.25rem auto 2rem;
    }
    .m5-admin-panel {
        border: 1px solid rgb(255 255 255 / 18%);
        border-radius: 1rem;
        padding: 1rem;
        background: linear-gradient(180deg, rgb(11 14 30 / 96%) 0%, rgb(9 12 23 / 94%) 100%);
    }
    .m5-admin-header {
        text-align: center;
        margin-bottom: 0.85rem;
    }
    .m5-admin-header img {
        width: min(280px, 70vw);
    }
    .m5-admin-header h1 {
        margin: 0.4rem 0 0.2rem;
        font-size: 1.8rem;
    }
    .m5-admin-header p {
        margin: 0;
        color: rgb(230 233 242 / 82%);
    }

    .m5-admin-login {
        display: flex;
        gap: 0.6rem;
        align-items: end;
        flex-wrap: wrap;
    }
    .m5-admin-login label {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: min(420px, 100%);
    }

    .m5-admin-login input,
    .m5-row input,
    .m5-row textarea,
    .m5-row select,
    .m5-modal-form input,
    .m5-modal-form textarea,
    .m5-modal-form select {
        border: 1px solid rgb(255 255 255 / 24%);
        border-radius: 0.5rem;
        background: rgb(8 12 23 / 75%);
        color: #f5f7fb;
        padding: 0.5rem 0.6rem;
        font: inherit;
        width: 100%;
        box-sizing: border-box;
    }

    .m5-modal-form input:focus,
    .m5-modal-form textarea:focus,
    .m5-modal-form select:focus {
        outline: 2px solid rgb(255 78 86 / 65%);
        outline-offset: 1px;
        border-color: #ff4e56;
    }

    .m5-admin-login button,
    .m5-admin-actions button,
    .m5-panel-head button,
    .m5-row button,
    .m5-modal button {
        border: 1px solid rgb(255 255 255 / 26%);
        border-radius: 0.55rem;
        background: rgb(12 17 31 / 85%);
        color: #fff;
        font: inherit;
        font-weight: 700;
        padding: 0.55rem 0.8rem;
        cursor: pointer;
    }

    .m5-admin-actions button:hover,
    .m5-admin-login button:hover,
    .m5-panel-head button:hover,
    .m5-row button:hover,
    .m5-modal button:hover {
        border-color: #ff4e56;
        color: #ff4e56;
    }

    .m5-admin-editor {
        display: grid;
        gap: 0.9rem;
    }
    .m5-admin-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.55rem;
    }

    .m5-tab-bar {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .m5-tab-btn {
        border: 1px solid rgb(255 255 255 / 20%);
        border-radius: 0.65rem;
        background: rgb(10 15 28 / 80%);
        color: #f5f8ff;
        font: inherit;
        font-weight: 700;
        padding: 0.45rem 0.7rem;
        cursor: pointer;
    }

    .m5-tab-btn.is-active {
        border-color: #ff4e56;
        color: #ff4e56;
        box-shadow: 0 0 0 1px rgb(255 78 86 / 20%);
    }

    .m5-tab-panel {
        border: 1px solid rgb(255 255 255 / 14%);
        border-radius: 0.8rem;
        padding: 0.8rem;
        background: rgb(7 11 21 / 45%);
    }

    .m5-panel-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.55rem;
        margin-bottom: 0.55rem;
    }

    .m5-panel-head h2 {
        margin: 0;
        font-size: 1.15rem;
    }

    .m5-admin-hint {
        margin: 0 0 0.5rem;
        color: rgb(230 233 242 / 78%);
        font-size: 0.92rem;
    }

    .m5-admin-list {
        display: grid;
        gap: 0.75rem;
    }

    .m5-row {
        border: 1px solid rgb(255 255 255 / 16%);
        border-radius: 0.8rem;
        padding: 0.7rem;
        display: grid;
        gap: 0.6rem 0.7rem;
        align-items: end;
    }

    .m5-artist-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .m5-venue-row,
    .m5-show-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .m5-row label {
        display: flex;
        flex-direction: column;
        gap: 0.23rem;
        font-size: 0.92rem;
    }

    .m5-span-2 {
        grid-column: span 2;
    }

    .m5-linked-preview {
        margin: 0;
        padding: 0.45rem 0.55rem;
        border-radius: 0.5rem;
        border: 1px solid rgb(255 255 255 / 14%);
        color: rgb(226 231 244 / 84%);
        background: rgb(10 14 24 / 65%);
        font-size: 0.9rem;
        line-height: 1.35;
    }

    .m5-admin-msg {
        margin: 0;
        color: rgb(230 233 242 / 86%);
        min-height: 1.25em;
    }

    .m5-modal {
        width: min(640px, calc(100vw - 2rem));
        border: 1px solid rgb(255 255 255 / 22%);
        border-radius: 0.9rem;
        background: linear-gradient(180deg, rgb(11 14 30 / 98%) 0%, rgb(9 12 23 / 96%) 100%);
        color: #f5f7fb;
        padding: 0;
    }

    .m5-modal::backdrop {
        background: rgb(3 7 16 / 70%);
        backdrop-filter: blur(1px);
    }

    .m5-modal-form {
        display: grid;
        gap: 0.65rem;
        padding: 0.95rem;
    }

    .m5-modal-form h3 {
        margin: 0;
        font-size: 1.2rem;
    }

    .m5-modal-form label {
        display: flex;
        flex-direction: column;
        gap: 0.23rem;
        font-size: 0.92rem;
    }

    .m5-modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        padding-top: 0.2rem;
    }

    @media (max-width: 860px) {
        .m5-checker {
            height: 32px;
            background-size: auto 100%, auto 100%;
        }
        .m5-admin-wrap {
            width: min(1200px, 100% - 1rem);
            margin-top: 0.7rem;
        }
        .m5-artist-row,
        .m5-venue-row,
        .m5-show-row {
            grid-template-columns: 1fr;
        }
        .m5-span-2 {
            grid-column: auto;
        }
        .m5-panel-head {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>

<script is:inline>
    (() => {
        const loginPanel = document.getElementById('loginPanel');
        const editorPanel = document.getElementById('editorPanel');
        const loginButton = document.getElementById('loginButton');
        const saveAllButton = document.getElementById('saveAllButton');
        const logoutButton = document.getElementById('logoutButton');
        const addArtistButton = document.getElementById('addArtistButton');
        const addVenueButton = document.getElementById('addVenueButton');
        const addShowButton = document.getElementById('addShowButton');

        const adminPassword = document.getElementById('adminPassword');
        const loginMessage = document.getElementById('loginMessage');
        const editorMessage = document.getElementById('editorMessage');

        const artistsList = document.getElementById('artistsList');
        const venuesList = document.getElementById('venuesList');
        const showsList = document.getElementById('showsList');

        const artistTemplate = document.getElementById('artistRowTemplate');
        const venueTemplate = document.getElementById('venueRowTemplate');
        const showTemplate = document.getElementById('showRowTemplate');
        const artistModal = document.getElementById('artistModal');
        const venueModal = document.getElementById('venueModal');
        const showModal = document.getElementById('showModal');
        const artistModalForm = document.getElementById('artistModalForm');
        const venueModalForm = document.getElementById('venueModalForm');
        const showModalForm = document.getElementById('showModalForm');

        const tabButtons = [...document.querySelectorAll('.m5-tab-btn')];
        const tabPanels = [...document.querySelectorAll('.m5-tab-panel')];

        const setEditorVisible = (visible) => {
            loginPanel.hidden = visible;
            editorPanel.hidden = !visible;
        };

        const setMessage = (el, text) => {
            el.textContent = text;
        };

        const setTab = (name) => {
            tabButtons.forEach((button) => {
                const isActive = button.getAttribute('data-tab') === name;
                button.classList.toggle('is-active', isActive);
                button.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
            tabPanels.forEach((panel) => {
                panel.hidden = panel.getAttribute('data-panel') !== name;
            });
        };

        const slug = (value) => value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        const isoToLocalInput = (isoString) => {
            if (!isoString || typeof isoString !== 'string') return '';
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return '';
            const local = new Date(date.getTime() - date.getTimezoneOffset() * 60000);
            return local.toISOString().slice(0, 16);
        };

        const localInputToIso = (localValue) => {
            if (!localValue) return '';
            const date = new Date(localValue);
            if (Number.isNaN(date.getTime())) return '';
            const pad = (n) => String(Math.abs(n)).padStart(2, '0');
            const tzMinutes = -date.getTimezoneOffset();
            const sign = tzMinutes >= 0 ? '+' : '-';
            const tzHours = pad(Math.trunc(tzMinutes / 60));
            const tzMins = pad(tzMinutes % 60);
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}:00${sign}${tzHours}:${tzMins}`;
        };

        const collectVenues = () =>
            Array.from(venuesList.querySelectorAll('.m5-venue-row')).map((row, index) => {
                const read = (field) => row.querySelector(`[data-field="${field}"]`)?.value.trim() ?? '';
                const name = read('name');
                const address = read('address');
                const generatedId = `${slug(name) || 'venue'}-${index + 1}`;
                const id = read('id') || generatedId;
                const directionsUrl = read('directionsUrl') || `https://maps.google.com/?q=${encodeURIComponent(address)}`;
                return {
                    id,
                    name,
                    address,
                    directionsUrl,
                    logoUrl: read('logoUrl') || '/images/logos/m5logo2.webp'
                };
            });

        const populateVenueSelect = (select, selectedId = '') => {
            const venues = collectVenues();
            select.innerHTML = '';

            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select a venue';
            select.appendChild(placeholder);

            venues.forEach((venue) => {
                const option = document.createElement('option');
                option.value = venue.id;
                option.textContent = `${venue.name} (${venue.address})`;
                select.appendChild(option);
            });

            select.value = selectedId && venues.some((venue) => venue.id === selectedId) ? selectedId : '';
        };

        const updateShowPreview = (row) => {
            const preview = row.querySelector('[data-field="venuePreview"]');
            const venueId = row.querySelector('[data-field="venueId"]')?.value;
            const venue = collectVenues().find((item) => item.id === venueId);
            preview.textContent = venue ? `Linked Venue: ${venue.name} â€” ${venue.address}` : 'Linked Venue: none selected';
        };

        const refreshVenueSelects = () => {
            showsList.querySelectorAll('[data-field="venueId"]').forEach((select) => {
                const current = select.value;
                populateVenueSelect(select, current);
                updateShowPreview(select.closest('.m5-show-row'));
            });
        };

        const populateModalVenueSelect = (selectedId = '') => {
            const select = showModalForm.querySelector('select[name="venueId"]');
            populateVenueSelect(select, selectedId);
        };

        const openModal = (modal, form) => {
            form.reset();
            modal.showModal();
            const firstInput = form.querySelector('input, textarea, select');
            firstInput?.focus();
        };

        const closeModal = (modal, form) => {
            form.reset();
            modal.close();
        };

        const readModalForm = (form) =>
            Object.fromEntries(
                Array.from(new FormData(form).entries()).map(([key, value]) => [key, typeof value === 'string' ? value.trim() : value])
            );

        const createVenueRow = (venue = {}) => {
            const node = venueTemplate.content.firstElementChild.cloneNode(true);
            node.querySelectorAll('[data-field]').forEach((input) => {
                const key = input.getAttribute('data-field');
                input.value = typeof venue[key] === 'string' ? venue[key] : '';
            });
            node.querySelector('[data-action="remove"]').addEventListener('click', () => {
                node.remove();
                refreshVenueSelects();
            });
            node.querySelectorAll('[data-field]').forEach((input) => {
                input.addEventListener('input', refreshVenueSelects);
            });
            venuesList.appendChild(node);
            refreshVenueSelects();
        };

        const createShowRow = (show = {}) => {
            const node = showTemplate.content.firstElementChild.cloneNode(true);
            node.querySelectorAll('[data-field]').forEach((input) => {
                const key = input.getAttribute('data-field');
                if (key === 'venueId' || key === 'venuePreview' || key === 'startDateTime') return;
                input.value = typeof show[key] === 'string' ? show[key] : '';
            });
            const dateInput = node.querySelector('[data-field="startDateTime"]');
            dateInput.value = isoToLocalInput(typeof show.startDateTime === 'string' ? show.startDateTime : '');

            const venueSelect = node.querySelector('[data-field="venueId"]');
            const fallbackVenueId =
                typeof show.venueId === 'string' && show.venueId.length > 0
                    ? show.venueId
                    : collectVenues().find((venue) => venue.name === show.venueName)?.id || '';

            populateVenueSelect(venueSelect, fallbackVenueId);
            updateShowPreview(node);

            venueSelect.addEventListener('change', () => updateShowPreview(node));
            node.querySelector('[data-action="remove"]').addEventListener('click', () => node.remove());
            showsList.appendChild(node);
        };

        const createArtistRow = (artist = {}) => {
            const node = artistTemplate.content.firstElementChild.cloneNode(true);
            node.querySelectorAll('[data-field]').forEach((input) => {
                const key = input.getAttribute('data-field');
                if (key === 'songs') {
                    input.value = Array.isArray(artist.songs) ? artist.songs.join('\n') : '';
                } else {
                    input.value = typeof artist[key] === 'string' ? artist[key] : '';
                }
            });
            node.querySelector('[data-action="remove"]').addEventListener('click', () => node.remove());
            artistsList.appendChild(node);
        };

        const collectShows = () => {
            const venues = collectVenues();
            return Array.from(showsList.querySelectorAll('.m5-show-row')).map((row, index) => {
                const read = (field) => row.querySelector(`[data-field="${field}"]`)?.value.trim() ?? '';
                const venueId = read('venueId');
                const venue = venues.find((item) => item.id === venueId);
                return {
                    id: read('id') || `show-${Date.now()}-${index}`,
                    eventName: read('eventName'),
                    startDateTime: localInputToIso(read('startDateTime')),
                    venueId,
                    venueName: venue?.name ?? '',
                    venueAddress: venue?.address ?? '',
                    directionsUrl: venue?.directionsUrl ?? '',
                    venueLogo: venue?.logoUrl || '/images/logos/m5logo2.webp'
                };
            });
        };

        const collectArtists = () =>
            Array.from(artistsList.querySelectorAll('.m5-artist-row')).map((row, index) => {
                const read = (field) => row.querySelector(`[data-field="${field}"]`)?.value.trim() ?? '';
                const songs = read('songs')
                    .split('\n')
                    .map((song) => song.trim())
                    .filter(Boolean);
                return {
                    id: read('id') || `artist-${Date.now()}-${index}`,
                    name: read('name'),
                    songs,
                    imageUrl: read('imageUrl') || undefined
                };
            });

        const loadAll = async () => {
            const [artistsRes, venuesRes, showsRes] = await Promise.all([fetch('/api/artists'), fetch('/api/venues'), fetch('/api/shows')]);
            const [artistsData, venuesData, showsData] = await Promise.all([artistsRes.json(), venuesRes.json(), showsRes.json()]);

            artistsList.innerHTML = '';
            venuesList.innerHTML = '';
            showsList.innerHTML = '';

            (venuesData.venues ?? []).forEach((venue) => createVenueRow(venue));
            (showsData.shows ?? []).forEach((show) => createShowRow(show));
            (artistsData.artists ?? []).forEach((artist) => createArtistRow(artist));

            refreshVenueSelects();
        };

        const login = async () => {
            setMessage(loginMessage, '');
            const password = adminPassword.value;
            const response = await fetch('/api/shows-login', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                setMessage(loginMessage, error.error ?? 'Unable to log in.');
                return;
            }
            await loadAll();
            setEditorVisible(true);
            setTab('artists');
        };

        const saveAll = async () => {
            setMessage(editorMessage, '');
            const venues = collectVenues();
            const shows = collectShows();
            const artists = collectArtists();

            const responses = await Promise.all([
                fetch('/api/venues', {
                    method: 'PUT',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ venues })
                }),
                fetch('/api/shows', {
                    method: 'PUT',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ shows })
                }),
                fetch('/api/artists', {
                    method: 'PUT',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ artists })
                })
            ]);

            const failed = responses.find((res) => !res.ok);
            if (failed) {
                const error = await failed.json().catch(() => ({}));
                setMessage(editorMessage, error.error ?? 'Save failed.');
                return;
            }

            setMessage(editorMessage, 'Saved. Artists, venues, and shows are updated.');
            refreshVenueSelects();
        };

        const logout = async () => {
            await fetch('/api/shows-logout', { method: 'POST' });
            adminPassword.value = '';
            setEditorVisible(false);
            setMessage(loginMessage, 'Locked.');
            setMessage(editorMessage, '');
            artistsList.innerHTML = '';
            venuesList.innerHTML = '';
            showsList.innerHTML = '';
        };

        [artistModal, venueModal, showModal].forEach((modal) => {
            modal.querySelector('[data-action="cancel"]').addEventListener('click', () => {
                const form = modal.querySelector('form');
                closeModal(modal, form);
            });
            modal.addEventListener('cancel', () => {
                const form = modal.querySelector('form');
                closeModal(modal, form);
            });
        });

        artistModalForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const values = readModalForm(artistModalForm);
            createArtistRow({
                id: values.id,
                name: values.name,
                songs: (values.songs || '')
                    .split('\n')
                    .map((song) => song.trim())
                    .filter(Boolean),
                imageUrl: values.imageUrl
            });
            closeModal(artistModal, artistModalForm);
        });

        venueModalForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const values = readModalForm(venueModalForm);
            createVenueRow({
                id: values.id,
                name: values.name,
                address: values.address,
                directionsUrl: values.directionsUrl,
                logoUrl: values.logoUrl
            });
            closeModal(venueModal, venueModalForm);
        });

        showModalForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const values = readModalForm(showModalForm);
            const venue = collectVenues().find((item) => item.id === values.venueId);
            createShowRow({
                id: values.id,
                eventName: values.eventName,
                startDateTime: localInputToIso(values.startDateTime),
                venueId: values.venueId,
                venueName: venue?.name ?? '',
                venueAddress: venue?.address ?? '',
                directionsUrl: venue?.directionsUrl ?? '',
                venueLogo: venue?.logoUrl || '/images/logos/m5logo2.webp'
            });
            closeModal(showModal, showModalForm);
        });

        loginButton.addEventListener('click', login);
        adminPassword.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                login();
            }
        });

        tabButtons.forEach((button) => {
            button.addEventListener('click', () => setTab(button.getAttribute('data-tab')));
        });

        addArtistButton.addEventListener('click', () => openModal(artistModal, artistModalForm));
        addVenueButton.addEventListener('click', () => openModal(venueModal, venueModalForm));
        addShowButton.addEventListener('click', () => {
            populateModalVenueSelect();
            openModal(showModal, showModalForm);
        });
        saveAllButton.addEventListener('click', saveAll);
        logoutButton.addEventListener('click', logout);
    })();
</script>
