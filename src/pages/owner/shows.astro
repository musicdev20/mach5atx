---
import '../../styles/globals.css';

export const prerender = false;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="robots" content="noindex,nofollow" />
        <title>Mach 5 Shows Admin</title>
    </head>
    <body class="m5-admin-body">
        <div class="m5-checker" aria-hidden="true"></div>
        <main class="m5-admin-wrap">
            <section class="m5-admin-panel">
                <header class="m5-admin-header">
                    <img src="/images/logos/m5logo2.webp" alt="Mach 5" />
                    <h1>Shows Admin</h1>
                    <p>Add, edit, remove, and save upcoming shows without code changes.</p>
                </header>

                <section id="loginPanel" class="m5-admin-login">
                    <label>
                        Admin Password
                        <input id="adminPassword" type="password" autocomplete="current-password" />
                    </label>
                    <button id="loginButton" type="button">Unlock</button>
                    <p id="loginMessage" class="m5-admin-msg"></p>
                </section>

                <section id="editorPanel" class="m5-admin-editor" hidden>
                    <div class="m5-admin-actions">
                        <button id="addShowButton" type="button">Add Show</button>
                        <button id="saveShowsButton" type="button">Save Changes</button>
                        <button id="logoutButton" type="button">Lock</button>
                    </div>
                    <p id="editorMessage" class="m5-admin-msg"></p>
                    <div id="showsList" class="m5-admin-list"></div>
                </section>
            </section>
        </main>

        <template id="showRowTemplate">
            <article class="m5-show-row">
                <label>Event Name<input data-field="eventName" type="text" /></label>
                <label>Venue Name<input data-field="venueName" type="text" /></label>
                <label>Venue Address<input data-field="venueAddress" type="text" /></label>
                <label>Start Date/Time (ISO)<input data-field="startDateTime" type="text" placeholder="2026-03-21T20:00:00-05:00" /></label>
                <label>Directions URL<input data-field="directionsUrl" type="url" /></label>
                <label>Venue Logo URL<input data-field="venueLogo" type="text" placeholder="/images/logos/m5logo2.webp" /></label>
                <label>ID<input data-field="id" type="text" /></label>
                <button data-action="remove" type="button">Remove</button>
            </article>
        </template>
    </body>
</html>

<style>
    .m5-admin-body {
        margin: 0;
        color: #f5f7fb;
        font-family: 'Inter Variable', ui-sans-serif, system-ui, sans-serif;
        background: radial-gradient(120% 120% at 50% 0%, #0d1222 0%, #02050f 58%, #01030a 100%);
    }
    .m5-checker {
        height: 48px;
        background:
            linear-gradient(180deg, rgb(255 255 255 / 10%) 0%, rgb(255 255 255 / 0%) 35%),
            url('/images/checkerboard.svg') center / auto 100% repeat-x;
        border-bottom: 1px solid #343a4a;
        box-shadow: inset 0 -1px 0 rgb(255 255 255 / 20%), 0 8px 24px rgb(0 0 0 / 30%);
    }
    .m5-admin-wrap {
        width: min(1100px, 100% - 2rem);
        margin: 1.25rem auto 2rem;
    }
    .m5-admin-panel {
        border: 1px solid rgb(255 255 255 / 18%);
        border-radius: 1rem;
        padding: 1rem;
        background: linear-gradient(180deg, rgb(11 14 30 / 96%) 0%, rgb(9 12 23 / 94%) 100%);
    }
    .m5-admin-header {
        text-align: center;
        margin-bottom: 0.85rem;
    }
    .m5-admin-header img {
        width: min(280px, 70vw);
    }
    .m5-admin-header h1 {
        margin: 0.4rem 0 0.2rem;
        font-size: 1.8rem;
    }
    .m5-admin-header p {
        margin: 0;
        color: rgb(230 233 242 / 82%);
    }
    .m5-admin-login {
        display: flex;
        gap: 0.6rem;
        align-items: end;
        flex-wrap: wrap;
    }
    .m5-admin-login label {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: min(420px, 100%);
    }
    .m5-admin-login input,
    .m5-show-row input {
        border: 1px solid rgb(255 255 255 / 24%);
        border-radius: 0.5rem;
        background: rgb(8 12 23 / 75%);
        color: #f5f7fb;
        padding: 0.5rem 0.6rem;
        font: inherit;
    }
    .m5-admin-login button,
    .m5-admin-actions button,
    .m5-show-row button {
        border: 1px solid rgb(255 255 255 / 26%);
        border-radius: 0.55rem;
        background: rgb(12 17 31 / 85%);
        color: #fff;
        font: inherit;
        font-weight: 700;
        padding: 0.55rem 0.8rem;
        cursor: pointer;
    }
    .m5-admin-actions button:hover,
    .m5-admin-login button:hover,
    .m5-show-row button:hover {
        border-color: #ff4e56;
        color: #ff4e56;
    }
    .m5-admin-editor {
        display: grid;
        gap: 0.8rem;
    }
    .m5-admin-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.55rem;
    }
    .m5-admin-list {
        display: grid;
        gap: 0.75rem;
    }
    .m5-show-row {
        border: 1px solid rgb(255 255 255 / 16%);
        border-radius: 0.8rem;
        padding: 0.7rem;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.6rem 0.7rem;
        align-items: end;
    }
    .m5-show-row label {
        display: flex;
        flex-direction: column;
        gap: 0.23rem;
        font-size: 0.92rem;
    }
    .m5-show-row [data-field='venueAddress'],
    .m5-show-row [data-field='directionsUrl'] {
        width: 100%;
    }
    .m5-admin-msg {
        margin: 0;
        color: rgb(230 233 242 / 86%);
        min-height: 1.25em;
    }
    @media (max-width: 860px) {
        .m5-checker {
            height: 32px;
            background-size: auto 100%, auto 100%;
        }
        .m5-admin-wrap {
            width: min(1100px, 100% - 1rem);
            margin-top: 0.7rem;
        }
        .m5-show-row {
            grid-template-columns: 1fr;
        }
    }
</style>

<script is:inline>
    (() => {
        const loginPanel = document.getElementById('loginPanel');
        const editorPanel = document.getElementById('editorPanel');
        const loginButton = document.getElementById('loginButton');
        const addShowButton = document.getElementById('addShowButton');
        const saveShowsButton = document.getElementById('saveShowsButton');
        const logoutButton = document.getElementById('logoutButton');
        const adminPassword = document.getElementById('adminPassword');
        const loginMessage = document.getElementById('loginMessage');
        const editorMessage = document.getElementById('editorMessage');
        const showsList = document.getElementById('showsList');
        const template = document.getElementById('showRowTemplate');

        const setEditorVisible = (visible) => {
            loginPanel.hidden = visible;
            editorPanel.hidden = !visible;
        };

        const setMessage = (el, text) => {
            el.textContent = text;
        };

        const createRow = (show = {}) => {
            const node = template.content.firstElementChild.cloneNode(true);
            node.querySelectorAll('[data-field]').forEach((input) => {
                const key = input.getAttribute('data-field');
                input.value = typeof show[key] === 'string' ? show[key] : '';
            });
            node.querySelector('[data-action="remove"]').addEventListener('click', () => node.remove());
            showsList.appendChild(node);
        };

        const collectShows = () =>
            Array.from(showsList.querySelectorAll('.m5-show-row')).map((row, index) => {
                const read = (field) => row.querySelector(`[data-field="${field}"]`)?.value.trim() ?? '';
                const venueLogo = read('venueLogo');
                return {
                    id: read('id') || `show-${Date.now()}-${index}`,
                    eventName: read('eventName'),
                    venueName: read('venueName'),
                    venueAddress: read('venueAddress'),
                    startDateTime: read('startDateTime'),
                    directionsUrl: read('directionsUrl'),
                    venueLogo: venueLogo || '/images/logos/m5logo2.webp'
                };
            });

        const loadShows = async () => {
            const response = await fetch('/api/shows');
            const data = await response.json();
            showsList.innerHTML = '';
            (data.shows ?? []).forEach((show) => createRow(show));
        };

        const login = async () => {
            setMessage(loginMessage, '');
            const password = adminPassword.value;
            const response = await fetch('/api/shows-login', {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ password })
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                setMessage(loginMessage, error.error ?? 'Unable to log in.');
                return;
            }
            await loadShows();
            setEditorVisible(true);
        };

        const save = async () => {
            setMessage(editorMessage, '');
            const response = await fetch('/api/shows', {
                method: 'PUT',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ shows: collectShows() })
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                setMessage(editorMessage, error.error ?? 'Save failed.');
                return;
            }
            setMessage(editorMessage, 'Saved. Upcoming shows are updated.');
        };

        const logout = async () => {
            await fetch('/api/shows-logout', { method: 'POST' });
            setEditorVisible(false);
            setMessage(editorMessage, '');
            setMessage(loginMessage, 'Locked.');
            adminPassword.value = '';
        };

        loginButton.addEventListener('click', login);
        addShowButton.addEventListener('click', () => createRow());
        saveShowsButton.addEventListener('click', save);
        logoutButton.addEventListener('click', logout);
        adminPassword.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') login();
        });
    })();
</script>
